<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circle Leaders</title>
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="supabaseClient.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Circle Leader Tracker</h1>
    </header>
    <div id="status-container">
      <span id="status-message"></span>
      <span id="spinner" style="display: none; margin-left: 10px;">‚è≥</span>
    </div>
    <div id="seed-button-container">
      <button id="seed-button">Seed Data</button>
      <button id="reset-button">Reset Data</button>
    </div>
    <div class="table-responsive">
      <table id="leaders-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be populated here -->
        </tbody>
      </table>
    </div>
    <form id="add-leader-form">
      <h2>Add New Leader</h2>
      <input type="text" id="full_name" placeholder="Full Name" required />
      <input type="text" id="phone" placeholder="Phone" required />
      <input type="email" id="email" placeholder="Email" required />
      <select id="status">
        <option value="invite">Invite</option>
        <option value="pipeline">Pipeline</option>
        <option value="leader">Leader</option>
      </select>
      <button type="submit">Add Leader</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script type="application/json" id="circle-data">
[
  {
    "full_name": "Mike Swan",
    "phone": "555-123-4567",
    "email": "mike@example.com",
    "status": "leader"
  },
  {
    "full_name": "Linsey Shields",
    "phone": "555-987-6543",
    "email": "linsey@example.com",
    "status": "pipeline"
  },
  {
    "full_name": "Jimmy McAfee",
    "phone": "555-333-1212",
    "email": "jimmy@example.com",
    "status": "invite"
  },
  {
    "full_name": "Pat Bowles",
    "phone": "555-777-8888",
    "email": "pat@example.com",
    "status": "leader"
  }
]
  </script>
  <script type="module">
    import { supabase as client } from './supabaseClient.js';

    function setStatus(message, loading = false) {
      document.getElementById('status-message').textContent = message;
      document.getElementById('spinner').style.display = loading ? 'inline' : 'none';
    }

    function clearStatus() {
      document.getElementById('status-message').textContent = '';
      document.getElementById('spinner').style.display = 'none';
    }

    async function loadCircleLeaders() {
      setStatus('Loading leaders...', true);
      const { data, error } = await client.from('circle_leaders').select('*');
      clearStatus();

      if (error) {
        console.error('Error fetching circle leaders:', error);
        setStatus('Failed to load leaders.');
        return;
      }

      const tbody = document.querySelector('#leaders-table tbody');
      tbody.innerHTML = '';

      data.forEach(leader => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${leader.full_name || ''}</td>
          <td>${leader.phone || ''}</td>
          <td>${leader.email || ''}</td>
          <td>${leader.status || ''}</td>
        `;
        tbody.appendChild(row);
      });

      setStatus(`Loaded ${data.length} leaders.`);
    }

    async function addCircleLeader(event) {
      event.preventDefault();

      const full_name = document.getElementById('full_name').value;
      const phone = document.getElementById('phone').value;
      const email = document.getElementById('email').value;
      const status = document.getElementById('status').value;

      const { error } = await client.from('circle_leaders').insert([
        { full_name, phone, email, status }
      ]);

      if (error) {
        console.error('Error adding leader:', error);
        return;
      }

      document.getElementById('add-leader-form').reset();
      loadCircleLeaders();
    }

    document.getElementById('add-leader-form').addEventListener('submit', addCircleLeader);

    document.getElementById('seed-button').addEventListener('click', async () => {
      await seedDatabaseFromJson();
      document.getElementById('seed-button-container').style.display = 'none';
    });

    loadCircleLeaders();

    async function seedDatabaseFromJson() {
      setStatus('Seeding data...', true);
      const jsonScript = document.getElementById('circle-data');
      if (!jsonScript) {
        clearStatus();
        return;
      }

      const data = JSON.parse(jsonScript.textContent);

      const { error } = await client.from('circle_leaders').insert(data);

      if (error) {
        console.error('Error seeding data:', error);
        clearStatus();
        setStatus('Failed to seed data.');
      } else {
        console.log('Seeded circle leaders successfully!');
        clearStatus();
        setStatus('Seeded successfully!');
        loadCircleLeaders();
      }
    }

    // seedDatabaseFromJson();

    async function resetDatabase() {
      const confirmed = confirm('Are you sure you want to reset the database? This will delete all current data and reload the default set.');
      if (!confirmed) return;

      setStatus('Resetting database...', true);

      const { error: deleteError } = await client.from('circle_leaders').delete().neq('id', 0);
      if (deleteError) {
        console.error('Error deleting leaders:', deleteError);
        clearStatus();
        setStatus('Failed to reset database.');
        return;
      }

      console.log('All data deleted. Reseeding...');
      await seedDatabaseFromJson();

      clearStatus();
      setStatus('Database reset and seeded successfully!');

      alert('Circle leaders reset successfully!');
    }

    document.getElementById('reset-button').addEventListener('click', resetDatabase);
  </script>
</body>
</html>
